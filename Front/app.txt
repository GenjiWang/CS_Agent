import React, { useState, useRef, useEffect } from 'react'

export default function App(){
    const [messages, setMessages] = useState([
        { id: 1, role: 'assistant', text: '歡迎！請輸入你的問題。' }
    ])
    const [input, setInput] = useState('')
    const [isLoading, setIsLoading] = useState(false)
    const panelRef = useRef(null)

    const nextId = () => Date.now() + Math.floor(Math.random() * 1000)

    useEffect(() => {
        // 自動滾到底
        if (panelRef.current) {
            panelRef.current.scrollTop = panelRef.current.scrollHeight
        }
    }, [messages])

    async function sendMessage() {
        const trimmed = input.trim()
        if (!trimmed) return

        const userMsg = { id: nextId(), role: 'user', text: trimmed }
        setMessages(prev => [...prev, userMsg])
        setInput('')
        setIsLoading(true)

        // 先插入一個空的 assistant 訊息，後續逐字填充
        const assistantId = nextId()
        setMessages(prev => [...prev, { id: assistantId, role: 'assistant', text: '' }])

        try {
            const res = await fetch('http://localhost:3001/chat/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: trimmed })
            })

            if (!res.ok || !res.body) throw new Error(`HTTP ${res.status}`)

            const reader = res.body.getReader()
            const decoder = new TextDecoder('utf-8')
            let done = false

            while (!done) {
                const { value, done: doneReading } = await reader.read()
                done = doneReading
                const chunk = decoder.decode(value || new Uint8Array(), { stream: !done })

                if (chunk) {
                    // 追加 chunk 到剛剛的 assistant 訊息
                    setMessages(prev => prev.map(m =>
                        m.id === assistantId ? { ...m, text: m.text + chunk } : m
                    ))
                }
            }
        } catch (err) {
            console.error(err)
            setMessages(prev => prev.map(m =>
                m.id === assistantId ? { ...m, text: '回覆失敗，請稍後再試。' } : m
            ))
        } finally {
            setIsLoading(false)
        }
    }


    return (
        <div className="app">
            <header className="header">
                <div className="container">
                    <div>
                        <h1>智慧聊天機器人</h1>
                        <div className="meta">建立 Ollama 的智慧聊天系統</div>
                    </div>
                </div>
            </header>

            <main className="chat-area">
                <div className="inner">
                    <div className="chat-panel" ref={panelRef}>
                        {messages.length === 0 ? (
                            <div className="empty">還沒有訊息，請輸入開始對話。</div>
                        ) : (
                            messages.map(msg => (
                                <div
                                    key={msg.id}
                                    className={`msg-row ${msg.role === 'user' ? 'user' : 'assistant'}`}
                                >
                                    <div className={`msg ${msg.role === 'user' ? 'user' : 'assistant'}`}>
                                        {msg.text}
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </main>

            <footer className="composer">
                <form
                    className="row"
                    onSubmit={e => {
                        e.preventDefault()
                        if (!isLoading && input.trim()) sendMessage()
                    }}
                >
                    <input
                        className="input"
                        type="text"
                        value={input}
                        onChange={e => setInput(e.target.value)}
                        placeholder="請輸入您的問題..."
                        disabled={isLoading}
                        aria-label="輸入訊息"
                        onKeyDown={e => {
                            if (e.key === 'Enter' && !e.shiftKey) {
                                e.preventDefault()
                                if (!isLoading && input.trim()) sendMessage()
                            }
                        }}
                    />
                    <button className="btn-send" type="submit" disabled={isLoading || !input.trim()}>
                        {isLoading ? '傳送中...' : '發送'}
                    </button>
                </form>
            </footer>
        </div>
    )
}